<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wolfram Rules Explorer (Elementary CA) - NKS Demo</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 20px; color: #e0e0e0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f0f 100%);
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 20px; padding: 16px;
      border: 1px solid rgba(255,215,0,0.25); border-radius: 12px;
      background: rgba(255,255,255,0.04); }
    .header h1 { margin: 0 0 8px; color: #ffd700; font-weight: 700; }
    .header p { margin: 0; color: #b8b8b8; }

    .layout { display: grid; grid-template-columns: 360px 1fr; gap: 16px; }
    @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }

    .panel { padding: 16px; border: 1px solid rgba(255,215,0,0.2);
      border-radius: 12px; background: rgba(255,255,255,0.04); }
    .panel h3 { margin: 0 0 12px; color: #ffd700; font-size: 1.05rem; }
    .row { display: flex; gap: 8px; align-items: center; margin: 8px 0; }
    .row > label { min-width: 120px; color: #d0d0d0; font-weight: 500; }
    .row input[type="range"], .row input[type="number"], .row select {
      flex: 1; padding: 8px; border-radius: 8px; border: 1px solid rgba(255,215,0,0.3);
      background: rgba(0,0,0,0.35); color: #e0e0e0;
    }
    .row .value { width: 46px; text-align: right; color: #ffd700; font-variant-numeric: tabular-nums; }
    .grid { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 8px; }
    .rule-cell { border: 1px solid rgba(255,215,0,0.25); border-radius: 8px; padding: 8px; text-align: center; }
    .pattern { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color: #d0d0d0; font-size: 0.9rem; margin-bottom: 6px; }
    .out-bit { width: 34px; height: 34px; border: 2px solid rgba(255,215,0,0.45); border-radius: 6px; margin: 0 auto; cursor: pointer;
      display: grid; place-items: center; font-weight: 700; color: #ffd700; user-select: none; transition: transform 120ms ease; }
    .out-bit:hover { transform: scale(1.06); border-color: #ffd700; }
    .out-bit.active { background: #ffd700; color: #1a1a1a; }

    .buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px; }
    button { padding: 10px; border-radius: 8px; border: 1px solid rgba(255,215,0,0.35);
      background: linear-gradient(45deg, rgba(255,215,0,0.15), rgba(255,215,0,0.25)); color: #f7e49a; cursor: pointer;
      transition: transform 120ms ease, background 160ms ease; font-weight: 600; }
    button:hover { transform: translateY(-1px); background: linear-gradient(45deg, rgba(255,215,0,0.25), rgba(255,215,0,0.35)); }
    button.secondary { background: rgba(255,255,255,0.06); color: #e0e0e0; }

    /* Presets & saved rules */
    .pill-list { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; }
    .pill { padding: 10px; border-radius: 10px; border: 1px solid rgba(255,215,0,0.3); cursor: pointer;
      background: rgba(255,255,255,0.05); color: #e0e0e0; text-align: center; transition: transform 120ms ease, border 160ms ease; }
    .pill:hover { transform: translateY(-1px); border-color: #ffd700; }
    .pill.active { background: rgba(255,215,0,0.2); color: #1a1a1a; border-color: #ffd700; }
    .saved-empty { color: #9a9a9a; font-style: italic; text-align: center; padding: 6px 0; }

    .canvas-wrap { text-align: center; }
    canvas { border: 2px solid rgba(255,215,0,0.3); border-radius: 10px; background: #000; max-width: 100%; image-rendering: pixelated; }

    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin-top: 12px; }
    .stat { padding: 10px; border-radius: 10px; background: rgba(0,0,0,0.35); border: 1px solid rgba(255,215,0,0.2); text-align: center; }
    .stat .label { color: #c8c8c8; font-size: 0.85rem; }
    .stat .val { color: #ffd700; font-weight: 700; font-variant-numeric: tabular-nums; }
  </style>
  <!-- Minimal, standalone demo; no external deps required -->
  <meta name="description" content="Explore Wolfram's 256 elementary cellular automata rules with an interactive rule table, rule number slider, seeds, and animation controls." />
  <meta name="robots" content="noindex" />
  <script>
  'use strict';

  // Elementary 1D CA with radius 1 (3-neighborhood), 2 states, 256 rules.
  class ElementaryRuleExplorer {
    constructor(opts = {}) {
      // Canvas / sizing
      this.canvas = document.getElementById(opts.canvasId || 'ecaCanvas');
      this.ctx = this.canvas.getContext('2d');
      this.width = opts.width || 256;   // cells per row
      this.maxRows = opts.rows || 256;  // generations (rows)
      this.cellSize = 2;                // pixel size per cell

      // Simulation state
      this.ruleNumber = 30;             // default (Rule 30)
      this.ruleBits = this.numToBits(this.ruleNumber);
      this.row = 0;                     // current written row index
      this.grid = this.makeGrid(this.maxRows, this.width);
      this.running = false;
      this.timer = null;
      this.speedLevel = 5;              // 1..10

      // UI wiring
      this.$ruleValue = document.getElementById('ruleValue');
      this.$genValue = document.getElementById('genValue');
      this.$activeValue = document.getElementById('activeValue');
      this.$ruleSlider = document.getElementById('ruleSlider');
      this.$widthSlider = document.getElementById('widthSlider');
      this.$rowsSlider = document.getElementById('rowsSlider');
      this.$speedSlider = document.getElementById('speedSlider');
      this.$seedSelect = document.getElementById('seedSelect');

      // Feature data
      this.presetRules = [
        { n: 30,  note: 'Random-like' },
        { n: 90,  note: 'Sierpinski' },
        { n: 110, note: 'Complex (Turing-complete)' },
        { n: 150, note: 'Fractal symmetry' },
        { n: 184, note: 'Traffic/particles' },
        { n: 126, note: 'Edge of chaos' },
        { n: 250, note: 'Periodic' },
        { n: 254, note: 'Filling' },
      ];
      this.savedRules = new Set();

      this.bindEvents();
      this.resizeCanvas();
      this.seedGrid('single');
      this.paintAll();
      this.reflectUI();
      this.initPresetUI();
      this.loadSavedRules();
      this.renderSavedRules();
      this.updateActiveHighlights();
      this.updateRuleAnalysis();
    }

    // --- helpers ---
    makeGrid(h, w) { return Array.from({ length: h }, () => new Array(w).fill(0)); }
    clamp(n, a, b) { return Math.min(Math.max(n, a), b); }
    delayMs(level) { return Math.max(10, 510 - level * 50); } // 1..10 => ~500..10ms
    numToBits(n) {
      const bits = new Array(8).fill(0);
      for (let i = 0; i < 8; i++) bits[i] = (n >> i) & 1; // 000 -> bit0 (LSB), 111 -> bit7 (MSB)
      return bits;
    }
    bitsToNum(bits) { return bits.reduce((acc, b, i) => acc | (b << i), 0); }
    patternIndex(l, c, r) { return (l << 2) | (c << 1) | r; }

    resizeCanvas() {
      this.canvas.width = this.width * this.cellSize;
      this.canvas.height = this.maxRows * this.cellSize;
      this.ctx.imageSmoothingEnabled = false;
    }

    seedGrid(type) {
      this.row = 0;
      this.grid = this.makeGrid(this.maxRows, this.width);
      const mid = Math.floor(this.width / 2);
      if (type === 'single') {
        this.grid[0][mid] = 1;
      } else if (type === 'random') {
        for (let x = 0; x < this.width; x++) this.grid[0][x] = (Math.random() < 0.5) ? 0 : 1;
      } else if (type === 'three') {
        // three random active cells near the center
        for (let i = 0; i < 3; i++) {
          const spread = Math.floor(this.width / 10) || 1;
          const pos = this.clamp(mid + Math.floor((Math.random() - 0.5) * 2 * spread), 0, this.width - 1);
          this.grid[0][pos] = 1;
        }
      } else if (type === 'alt') {
        for (let x = 0; x < this.width; x++) this.grid[0][x] = x % 2;
      }
      this.updateStats();
    }

    // --- UI ---
    bindEvents() {
      // Toggle output bits via 8 squares
      document.querySelectorAll('.out-bit').forEach((el) => {
        el.addEventListener('click', () => {
          const p = parseInt(el.dataset.pattern, 10); // 0..7 (000..111)
          const next = el.classList.contains('active') ? 0 : 1;
          this.ruleBits[p] = next;
          this.ruleNumber = this.bitsToNum(this.ruleBits);
          this.reflectUI();
          this.paintAll();
        });
      });

      // Rule slider 0..255
      this.$ruleSlider.addEventListener('input', (e) => {
        const n = this.clamp(parseInt(e.target.value, 10) || 0, 0, 255);
        this.setRule(n);
      });

      // Width / rows / speed
      this.$widthSlider.addEventListener('input', (e) => {
        const w = this.clamp(parseInt(e.target.value, 10) || this.width, 32, 1024);
        this.width = w; this.resizeCanvas(); this.seedGrid(this.$seedSelect.value); this.paintAll(); this.reflectUI();
      });
      this.$rowsSlider.addEventListener('input', (e) => {
        const r = this.clamp(parseInt(e.target.value, 10) || this.maxRows, 32, 1024);
        this.maxRows = r; this.resizeCanvas(); this.seedGrid(this.$seedSelect.value); this.paintAll(); this.reflectUI();
      });
      this.$speedSlider.addEventListener('input', (e) => {
        this.speedLevel = this.clamp(parseInt(e.target.value, 10) || 5, 1, 10);
        this.reflectUI();
      });

      // Seed selection
      this.$seedSelect.addEventListener('change', () => {
        this.stop(); this.seedGrid(this.$seedSelect.value); this.paintAll();
      });

      // Buttons
      document.getElementById('startBtn').addEventListener('click', () => this.start());
      document.getElementById('stopBtn').addEventListener('click', () => this.stop());
      document.getElementById('resetBtn').addEventListener('click', () => { this.stop(); this.seedGrid(this.$seedSelect.value); this.paintAll(); });
      document.getElementById('stepBtn').addEventListener('click', () => this.step());
      document.getElementById('randomRuleBtn').addEventListener('click', () => {
        const n = Math.floor(Math.random() * 256); this.setRule(n);
      });
      document.getElementById('saveRuleBtn').addEventListener('click', () => this.saveCurrentRule());
    }

    reflectUI() {
      // Rule number and slider value
      this.$ruleValue.textContent = this.ruleNumber;
      this.$ruleSlider.value = String(this.ruleNumber);
      // Toggle grid bits to match ruleBits
      document.querySelectorAll('.out-bit').forEach((el) => {
        const p = parseInt(el.dataset.pattern, 10);
        const active = this.ruleBits[p] === 1;
        el.classList.toggle('active', active);
        el.textContent = active ? '1' : '0';
      });
      // Stats
      this.$genValue.textContent = this.row;
      this.$activeValue.textContent = this.countActiveInRow(this.row);
      // Dimensions & speed echo
      document.getElementById('widthVal').textContent = this.width;
      document.getElementById('rowsVal').textContent = this.maxRows;
      document.getElementById('speedVal').textContent = this.speedLevel;
      this.updateActiveHighlights();
      this.updateRuleAnalysis();
    }

    setRule(n) {
      this.ruleNumber = this.clamp(n, 0, 255);
      this.ruleBits = this.numToBits(this.ruleNumber);
      this.reflectUI();
      this.paintAll();
    }

    // --- simulation ---
    nextRow(y) {
      const ny = y + 1; if (ny >= this.maxRows) return;
      for (let x = 0; x < this.width; x++) {
        const L = this.grid[y][(x - 1 + this.width) % this.width];
        const C = this.grid[y][x];
        const R = this.grid[y][(x + 1) % this.width];
        const idx = this.patternIndex(L, C, R);
        this.grid[ny][x] = this.ruleBits[idx];
      }
    }

    step() {
      if (this.row >= this.maxRows - 1) return;
      this.nextRow(this.row);
      this.row++;
      this.paintRow(this.row);
      this.updateStats();
    }

    start() {
      if (this.running) return; this.running = true;
      const tick = () => {
        if (!this.running) return;
        if (this.row >= this.maxRows - 1) { this.stop(); return; }
        this.step();
        this.timer = setTimeout(tick, this.delayMs(this.speedLevel));
      };
      tick();
    }

    stop() { this.running = false; if (this.timer) { clearTimeout(this.timer); this.timer = null; } }

    // --- drawing ---
    paintAll() {
      const s = this.cellSize;
      this.ctx.fillStyle = '#000';
      this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
      this.ctx.fillStyle = '#ffd700';
      for (let y = 0; y <= this.row; y++) {
        for (let x = 0; x < this.width; x++) if (this.grid[y][x] === 1) this.ctx.fillRect(x * s, y * s, s, s);
      }
    }

    paintRow(y) {
      const s = this.cellSize;
      this.ctx.fillStyle = '#000';
      this.ctx.fillRect(0, y * s, this.canvas.width, s);
      this.ctx.fillStyle = '#ffd700';
      for (let x = 0; x < this.width; x++) if (this.grid[y][x] === 1) this.ctx.fillRect(x * s, y * s, s, s);
    }

    countActiveInRow(y) { if (y < 0 || y >= this.maxRows) return 0; return this.grid[y].reduce((a, c) => a + c, 0); }

    updateStats() {
      this.$genValue.textContent = this.row;
      this.$activeValue.textContent = this.countActiveInRow(this.row);
      this.updateRuleAnalysis();
    }

    // --- presets & saved rules ---
    initPresetUI() {
      const host = document.getElementById('presetList');
      host.innerHTML = '';
      const frag = document.createDocumentFragment();
      this.presetRules.forEach(pr => {
        const el = document.createElement('div');
        el.className = 'pill';
        el.dataset.rule = String(pr.n);
        el.title = pr.note;
        el.textContent = `Rule ${pr.n}`;
        el.addEventListener('click', () => this.setRule(pr.n));
        frag.appendChild(el);
      });
      host.appendChild(frag);
    }

    updateActiveHighlights() {
      // Presets
      document.querySelectorAll('#presetList .pill').forEach(el => {
        el.classList.toggle('active', parseInt(el.dataset.rule, 10) === this.ruleNumber);
      });
      // Saved
      document.querySelectorAll('#savedList .pill').forEach(el => {
        el.classList.toggle('active', parseInt(el.dataset.rule, 10) === this.ruleNumber);
      });
    }

    storageKey() { return 'nksEcaSavedRules'; }
    loadSavedRules() {
      try {
        const raw = localStorage.getItem(this.storageKey());
        if (!raw) return;
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) arr.forEach(n => this.savedRules.add(this.clamp(n, 0, 255)));
      } catch {}
    }
    persistSavedRules() {
      try { localStorage.setItem(this.storageKey(), JSON.stringify(Array.from(this.savedRules))); } catch {}
    }

    renderSavedRules() {
      const host = document.getElementById('savedList');
      host.innerHTML = '';
      if (this.savedRules.size === 0) {
        const empty = document.createElement('div'); empty.className = 'saved-empty'; empty.textContent = 'No saved rules';
        host.appendChild(empty);
        return;
      }
      const frag = document.createDocumentFragment();
      Array.from(this.savedRules).sort((a,b)=>a-b).forEach(n => {
        const wrap = document.createElement('div'); wrap.className = 'pill'; wrap.dataset.rule = String(n);
        wrap.textContent = `Rule ${n}`;
        wrap.addEventListener('click', (e) => {
          if (e.target && e.target.classList && e.target.classList.contains('rm')) return;
          this.setRule(n);
        });
        const rm = document.createElement('button'); rm.className = 'rm'; rm.textContent = '×';
        rm.style.float = 'right'; rm.style.marginLeft = '8px'; rm.style.border = 'none'; rm.style.background = 'transparent'; rm.style.color = '#e0e0e0'; rm.style.cursor = 'pointer';
        rm.addEventListener('click', (e) => { e.stopPropagation(); this.savedRules.delete(n); this.persistSavedRules(); this.renderSavedRules(); this.updateActiveHighlights(); });
        wrap.appendChild(rm);
        frag.appendChild(wrap);
      });
      host.appendChild(frag);
      this.updateActiveHighlights();
    }

    saveCurrentRule() {
      this.savedRules.add(this.ruleNumber);
      this.persistSavedRules();
      this.renderSavedRules();
    }

    // --- analysis ---
    ruleAnalyses() {
      return {
        30:  'Rule 30: produces randomness-like complexity; classic NKS example.',
        90:  'Rule 90: Sierpinski triangle fractal; nested self-similarity.',
        110: 'Rule 110: proven Turing-complete; complex interacting structures.',
        150: 'Rule 150: symmetric fractal patterns; related to Rule 90.',
        184: 'Rule 184: particle/traffic flow; density and movement effects.',
        250: 'Rule 250: simple periodic patterns; checkerboard-like behavior.',
        254: 'Rule 254: fills the lattice; near-uniform active state.',
        126: 'Rule 126: at the edge of chaos; structured yet irregular.'
      };
    }
    patternTypeHeuristic() {
      if (this.ruleNumber === 30) return 'Random-complex';
      if (this.ruleNumber === 110) return 'Complex structures';
      if (this.ruleNumber === 184) return 'Particles';
      if (this.ruleNumber === 90 || this.ruleNumber === 150) return 'Fractal';
      if (this.ruleNumber === 250 || this.ruleNumber === 254) return 'Periodic/Solid';
      const active = this.countActiveInRow(this.row);
      if (active === 0) return 'Extinction';
      if (active > this.width * 0.7) return 'Filling';
      return 'Custom';
    }
    updateRuleAnalysis() {
      const a = this.ruleAnalyses();
      const text = a[this.ruleNumber] || `Rule ${this.ruleNumber}: observe emergent behavior and classify.`;
      const el = document.getElementById('analysisText'); if (el) el.textContent = text;
      const pt = document.getElementById('patternType'); if (pt) pt.textContent = this.patternTypeHeuristic();
    }
  }

  // bootstrap
  window.addEventListener('DOMContentLoaded', () => {
    // Build rule grid UI in DOM order 111,110,101,100,011,010,001,000 → pattern index 7..0
    const patterns = ['111','110','101','100','011','010','001','000'];
    const gridHost = document.getElementById('ruleGrid');
    const frag = document.createDocumentFragment();
    patterns.forEach((pStr) => {
      const p = parseInt(pStr, 2); // 7..0
      const cell = document.createElement('div'); cell.className = 'rule-cell';
      const pat = document.createElement('div'); pat.className = 'pattern'; pat.textContent = pStr.replace(/0/g, '○').replace(/1/g, '●');
      const bit = document.createElement('div'); bit.className = 'out-bit'; bit.dataset.pattern = String(p); bit.textContent = '0';
      cell.appendChild(pat); cell.appendChild(bit); frag.appendChild(cell);
    });
    gridHost.appendChild(frag);

    // Instantiate explorer
    window.eca = new ElementaryRuleExplorer({ canvasId: 'ecaCanvas', width: 256, rows: 256 });
  });
  </script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Wolfram Rules Explorer (Elementary CA)</h1>
      <p>Explore the 256 elementary cellular automata from A New Kind of Science</p>
    </div>

    <div class="layout">
      <div class="panel">
        <h3>Rule Definition</h3>
        <div class="grid" id="ruleGrid"></div>

        <div class="row">
          <label for="ruleSlider">Rule Number</label>
          <input id="ruleSlider" type="range" min="0" max="255" value="30" />
          <div class="value" id="ruleValue">30</div>
        </div>

        <div class="row">
          <label for="seedSelect">Initial Row</label>
          <select id="seedSelect">
            <option value="single">Single 1 in center</option>
            <option value="three">Three random cells</option>
            <option value="alt">Alternating 0101…</option>
            <option value="random">Random</option>
          </select>
        </div>

        <div class="row">
          <label for="widthSlider">Width (cells)</label>
          <input id="widthSlider" type="range" min="32" max="1024" value="256" />
          <div class="value" id="widthVal">256</div>
        </div>
        <div class="row">
          <label for="rowsSlider">Generations</label>
          <input id="rowsSlider" type="range" min="32" max="1024" value="256" />
          <div class="value" id="rowsVal">256</div>
        </div>
        <div class="row">
          <label for="speedSlider">Speed</label>
          <input id="speedSlider" type="range" min="1" max="10" value="5" />
          <div class="value" id="speedVal">5</div>
        </div>

        <div class="buttons">
          <button id="startBtn">Start</button>
          <button id="stopBtn" class="secondary">Stop</button>
          <button id="stepBtn" class="secondary">Step</button>
        </div>
        <div class="buttons" style="grid-template-columns: repeat(2, 1fr);">
          <button id="resetBtn" class="secondary">Reset</button>
          <button id="randomRuleBtn">Random Rule</button>
        </div>

        <h3 style="margin-top:16px;">Preset Rules</h3>
        <div id="presetList" class="pill-list"></div>

        <h3 style="margin-top:16px;">Saved Rules</h3>
        <div class="row">
          <button id="saveRuleBtn" style="width:100%;">Save Current Rule</button>
        </div>
        <div id="savedList" class="pill-list"></div>

        <div class="stats">
          <div class="stat"><div class="label">Generation</div><div class="val" id="genValue">0</div></div>
          <div class="stat"><div class="label">Active Cells</div><div class="val" id="activeValue">0</div></div>
          <div class="stat"><div class="label">Pattern Type</div><div class="val" id="patternType">Custom</div></div>
        </div>
      </div>

      <div class="panel canvas-wrap">
        <h3>Evolution</h3>
        <canvas id="ecaCanvas" width="512" height="512"></canvas>
        <p style="color:#b8b8b8; margin-top:8px; font-size:0.9rem;">Top row is the initial condition; each subsequent row is the next generation.</p>

        <div class="panel" style="margin-top:12px;">
          <h3>Rule Analysis</h3>
          <p id="analysisText" style="margin:0; color:#d0d0d0;">Rule 30: produces randomness-like complexity; classic NKS example.</p>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
