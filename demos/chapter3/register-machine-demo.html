<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Register Machines – NKS Chapter 3</title>
  <style>
    :root { color-scheme: light dark; }
    body {
      margin: 0;
      font-family: "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f5;
      color: #1f1f1f;
    }
    main { max-width: 880px; margin: 0 auto; padding: 30px 20px 42px; }
    header { margin-bottom: 24px; }
    h1 { margin: 0 0 0.4rem; font-size: 1.9rem; }
    p { margin: 0; line-height: 1.55; }
    section {
      background: #fff;
      border: 1px solid #d8d8d8;
      border-radius: 10px;
      padding: 18px 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .controls { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    label { display: block; font-weight: 600; margin-bottom: 6px; }
    select, button {
      font: inherit;
      padding: 7px 9px;
      border-radius: 6px;
      border: 1px solid #b6b6b6;
      background: #fff;
      width: 100%;
    }
    button {
      background: #1f63c7;
      border-color: #1f63c7;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    button.secondary {
      background: #f1f1f1;
      border-color: #c2c2c2;
      color: #232323;
    }
    button + button { margin-top: 8px; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #c8c8c8; padding: 6px 8px; text-align: center; }
    th { background: #f1f1f1; }
    .instructions { list-style: decimal-leading-zero; margin: 12px 0 0 24px; padding: 0; }
    .instructions li { padding: 4px 6px; border-radius: 6px; margin-bottom: 4px; }
    .instructions li.active { background: #ffe066; }
    .stats { display: flex; flex-wrap: wrap; gap: 16px; font-size: 0.95rem; margin-top: 12px; }
    .stat { min-width: 120px; }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>Small Register Machines</h1>
      <p>
        Wolfram’s register-machine experiments (pages 98–100) track how behaviour shifts as the number of instructions grows. The
        programs below use the exact instruction sequences from the original demo: a three-instruction repeater, a five-instruction
        loop, and an eight-instruction example that already exhibits tangled register interactions.
      </p>
    </header>

    <section class="controls">
      <div>
        <label for="program-select">Choose program</label>
        <select id="program-select">
          <option value="increment">3 instructions – repetitive</option>
          <option value="add">5 instructions – nested</option>
          <option value="multiply">8 instructions – complex</option>
        </select>
      </div>
      <div>
        <label>Simulation control</label>
        <button id="run-btn">Run</button>
        <button id="step-btn" class="secondary">Step once</button>
        <button id="reset-btn" class="secondary">Reset</button>
      </div>
      <div>
        <label>Registers</label>
        <table>
          <thead>
            <tr id="register-header"></tr>
          </thead>
          <tbody>
            <tr id="register-values"></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section>
      <h2 style="font-size:1.1rem;margin-top:0;">Instruction list</h2>
      <ol id="instruction-list" class="instructions"></ol>
      <div class="stats">
        <div class="stat"><strong>Step:</strong> <span id="step-count">0</span></div>
        <div class="stat"><strong>Program counter:</strong> <span id="pc">0</span></div>
      </div>
    </section>
  </main>

  <script>
    const PROGRAMS = {
      increment: {
        instructions: ['INC R0', 'INC R0', 'INC R0', 'HALT'],
        initial: [0, 0, 0]
      },
      add: {
        instructions: ['DEC R1 5', 'INC R0', 'DEC R1 5', 'INC R0', 'HALT'],
        initial: [0, 3, 0]
      },
      multiply: {
        instructions: ['DEC R1 8', 'DEC R2 6', 'INC R0', 'DEC R2 6', 'INC R2', 'DEC R1 8', 'INC R1', 'HALT'],
        initial: [0, 2, 3]
      }
    };

    class RegisterMachineDemo {
      constructor() {
        this.setProgram('increment');
        this.running = false;
        this.timer = null;
      }

      setProgram(name) {
        const program = PROGRAMS[name];
        this.program = program.instructions;
        this.initial = program.initial;
        this.reset();
        this.renderInstructions();
        this.renderRegisters();
      }

      reset() {
        this.stop();
        this.registers = [...this.initial];
        this.pc = 0;
        this.steps = 0;
        this.renderRegisters();
        this.highlightInstruction();
        this.updateStats();
      }

      step() {
        if (this.pc >= this.program.length) {
          this.stop();
          return false;
        }
        const instruction = this.program[this.pc];
        const parts = instruction.split(' ');
        const op = parts[0];
        if (op === 'INC') {
          const reg = parseInt(parts[1].substring(1), 10);
          this.ensureRegister(reg);
          this.registers[reg] += 1;
          this.pc += 1;
        } else if (op === 'DEC') {
          const reg = parseInt(parts[1].substring(1), 10);
          const target = parseInt(parts[2], 10) - 1;
          this.ensureRegister(reg);
          if (this.registers[reg] > 0) {
            this.registers[reg] -= 1;
            this.pc += 1;
          } else {
            this.pc = target;
          }
        } else if (op === 'HALT') {
          this.stop();
          return false;
        }
        this.steps += 1;
        this.renderRegisters();
        this.highlightInstruction();
        this.updateStats();
        return true;
      }

      run() {
        if (this.running) return;
        this.running = true;
        const loop = () => {
          if (!this.running) return;
          const progressed = this.step();
          if (progressed) {
            this.timer = setTimeout(() => requestAnimationFrame(loop), 160);
          }
        };
        loop();
      }

      stop() {
        this.running = false;
        if (this.timer) {
          clearTimeout(this.timer);
          this.timer = null;
        }
      }

      ensureRegister(index) {
        while (this.registers.length <= index) {
          this.registers.push(0);
        }
      }

      renderRegisters() {
        const headerRow = document.getElementById('register-header');
        const valueRow = document.getElementById('register-values');
        headerRow.innerHTML = '';
        valueRow.innerHTML = '';
        this.registers.forEach((value, index) => {
          const th = document.createElement('th');
          th.textContent = `R${index}`;
          headerRow.appendChild(th);
          const td = document.createElement('td');
          td.textContent = value;
          valueRow.appendChild(td);
        });
      }

      renderInstructions() {
        const list = document.getElementById('instruction-list');
        list.innerHTML = '';
        this.program.forEach(instruction => {
          const li = document.createElement('li');
          li.textContent = instruction;
          list.appendChild(li);
        });
        this.highlightInstruction();
      }

      highlightInstruction() {
        const items = document.querySelectorAll('#instruction-list li');
        items.forEach((item, index) => {
          item.classList.toggle('active', index === this.pc);
        });
      }

      updateStats() {
        document.getElementById('step-count').textContent = this.steps.toString();
        document.getElementById('pc').textContent = this.pc.toString();
      }
    }

    const demo = new RegisterMachineDemo();

    document.getElementById('program-select').addEventListener('change', (event) => {
      demo.setProgram(event.target.value);
      document.getElementById('run-btn').textContent = 'Run';
    });

    document.getElementById('run-btn').addEventListener('click', () => {
      if (demo.running) {
        demo.stop();
        document.getElementById('run-btn').textContent = 'Run';
      } else {
        demo.run();
        document.getElementById('run-btn').textContent = 'Pause';
      }
    });

    document.getElementById('step-btn').addEventListener('click', () => {
      demo.stop();
      document.getElementById('run-btn').textContent = 'Run';
      demo.step();
    });

    document.getElementById('reset-btn').addEventListener('click', () => {
      demo.reset();
      document.getElementById('run-btn').textContent = 'Run';
    });
  </script>
</body>
</html>
