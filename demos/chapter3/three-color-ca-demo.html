<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Three-Color Cellular Automata – NKS Chapter 3</title>
  <style>
    :root { color-scheme: light dark; }
    body {
      margin: 0;
      font-family: "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f5;
      color: #1d1d1d;
    }
    main {
      max-width: 980px;
      margin: 0 auto;
      padding: 28px 20px 40px;
    }
    header {
      margin-bottom: 22px;
    }
    h1 {
      font-size: 1.9rem;
      margin: 0 0 0.35rem;
    }
    p {
      margin: 0;
      line-height: 1.55;
    }
    section {
      background: #fff;
      border: 1px solid #d7d7d7;
      border-radius: 10px;
      padding: 18px 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }
    .controls {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      align-items: end;
    }
    label {
      display: block;
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 6px;
    }
    select, input[type="number"], button {
      font: inherit;
      padding: 7px 9px;
      border-radius: 6px;
      border: 1px solid #b7b7b7;
      background: #fff;
      width: 100%;
    }
    button {
      cursor: pointer;
      background: #1f63c7;
      border-color: #1f63c7;
      color: #fff;
      font-weight: 600;
    }
    button.secondary {
      background: #f3f3f3;
      border-color: #b7b7b7;
      color: #222;
    }
    button + button { margin-top: 8px; }
    canvas {
      width: 100%;
      max-width: 940px;
      border: 1px solid #a7a7a7;
      background: #000;
      display: block;
      image-rendering: pixelated;
    }
    .rule-table {
      display: grid;
      grid-template-columns: repeat(7, minmax(60px,1fr));
      gap: 8px;
      margin-top: 16px;
    }
    .rule-card {
      text-align: center;
      padding: 8px 4px;
      border-radius: 6px;
      font-size: 0.8rem;
      border: 1px solid #c6c6c6;
    }
    .stats {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-top: 14px;
      font-size: 0.95rem;
    }
    .stat {
      min-width: 110px;
    }
    @media (max-width: 640px) {
      section { padding: 16px; }
      .rule-table { grid-template-columns: repeat(3, minmax(60px,1fr)); }
    }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>Three-Color Cellular Automata</h1>
      <p>
        This recreation implements the exact totalistic three-color rules from chapter 3 of <em>A New Kind of Science</em>.
        Choose the same rules and initial conditions Wolfram used—rule 777, rule 924, and the other reference cases—and
        watch the successive rows accumulate exactly as in the original online demo.
      </p>
    </header>

    <section class="controls">
      <div>
        <label for="rule-select">Rule (totalistic number 0–2186)</label>
        <select id="rule-select">
          <option value="777">Rule 777 – Complex</option>
          <option value="600">Rule 600 – Nested triangles</option>
          <option value="924">Rule 924 – Nested</option>
          <option value="1059">Rule 1059 – Fractal banding</option>
          <option value="1545">Rule 1545 – Chaotic</option>
          <option value="1635">Rule 1635 – Periodic</option>
          <option value="custom">Custom…</option>
        </select>
      </div>
      <div id="custom-wrapper" style="display:none">
        <label for="custom-rule">Enter custom rule</label>
        <input id="custom-rule" type="number" min="0" max="2186" value="777" />
      </div>
      <div>
        <label for="seed-select">Initial row</label>
        <select id="seed-select">
          <option value="single">Single black cell</option>
          <option value="pair">Two cells (black/gray)</option>
          <option value="random">Random colors</option>
          <option value="stripe">Repeating 0 1 2 stripe</option>
        </select>
      </div>
      <div>
        <label>Controls</label>
        <button id="run-btn">Run</button>
        <button id="step-btn" class="secondary">Step once</button>
        <button id="reset-btn" class="secondary">Reset</button>
      </div>
    </section>

    <section>
      <canvas id="ca-canvas" width="900" height="540"></canvas>
      <div class="rule-table" id="rule-table"></div>
      <div class="stats">
        <div class="stat"><strong>Current rule:</strong> <span id="rule-label">777</span></div>
        <div class="stat"><strong>Generation:</strong> <span id="generation">0</span></div>
        <div class="stat"><strong>White:</strong> <span id="white-count">0</span></div>
        <div class="stat"><strong>Gray:</strong> <span id="gray-count">0</span></div>
        <div class="stat"><strong>Black:</strong> <span id="black-count">0</span></div>
      </div>
    </section>
  </main>

  <script>
    const COLOR_SET = ['#ffffff', '#888888', '#000000'];
    const RULE_PRESETS = [777, 600, 924, 1059, 1545, 1635];

    class ThreeColorAutomaton {
      constructor(canvas) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.width = 201;
        this.height = 270;
        this.pixelWidth = Math.floor(canvas.width / this.width);
        this.pixelHeight = Math.floor(canvas.height / this.height);
        this.rows = Array.from({ length: this.height }, () => new Array(this.width).fill(0));
        this.rule = 777;
        this.ruleTable = this.makeRuleTable(777);
        this.seed = 'single';
        this.running = false;
        this.generation = 0;
        this.frameHandle = null;
        this.draw();
      }

      makeRuleTable(ruleNumber) {
        const ternary = ruleNumber.toString(3).padStart(7, '0');
        const table = {};
        for (let sum = 0; sum <= 6; sum++) {
          table[sum] = parseInt(ternary[6 - sum], 10);
        }
        return table;
      }

      setRule(ruleNumber) {
        this.rule = Math.max(0, Math.min(2186, ruleNumber));
        this.ruleTable = this.makeRuleTable(this.rule);
        this.reset();
      }

      setSeed(seed) {
        this.seed = seed;
        this.reset();
      }

      reset() {
        this.stop();
        this.generation = 0;
        this.rows.forEach(row => row.fill(0));
        const firstRow = this.rows[0];
        const mid = Math.floor(this.width / 2);
        if (this.seed === 'single') {
          firstRow[mid] = 2;
        } else if (this.seed === 'pair') {
          firstRow[mid] = 2;
          firstRow[mid + 1] = 1;
        } else if (this.seed === 'random') {
          for (let i = 0; i < this.width; i++) {
            firstRow[i] = Math.floor(Math.random() * 3);
          }
        } else if (this.seed === 'stripe') {
          for (let i = 0; i < this.width; i++) {
            firstRow[i] = i % 3;
          }
        }
        this.draw();
        this.updateStats(firstRow);
      }

      neighbourhoodSum(row, x) {
        const left = row[(x - 1 + this.width) % this.width];
        const center = row[x];
        const right = row[(x + 1) % this.width];
        return left + center + right;
      }

      step() {
        const previous = this.rows[this.generation];
        if (!previous) { return; }
        const next = new Array(this.width);
        for (let x = 0; x < this.width; x++) {
          const sum = this.neighbourhoodSum(previous, x);
          next[x] = this.ruleTable[sum];
        }
        this.generation += 1;
        if (this.generation >= this.height) {
          this.rows.shift();
          this.rows.push(next);
          this.generation = this.height - 1;
        } else {
          this.rows[this.generation] = next;
        }
        this.draw();
        this.updateStats(next);
      }

      run() {
        if (this.running) return;
        this.running = true;
        const loop = () => {
          if (!this.running) return;
          this.step();
          this.frameHandle = setTimeout(() => requestAnimationFrame(loop), 90);
        };
        loop();
      }

      stop() {
        this.running = false;
        if (this.frameHandle) {
          clearTimeout(this.frameHandle);
          this.frameHandle = null;
        }
      }

      draw() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        for (let y = 0; y < this.height; y++) {
          const row = this.rows[y];
          if (!row) continue;
          for (let x = 0; x < this.width; x++) {
            this.ctx.fillStyle = COLOR_SET[row[x]];
            this.ctx.fillRect(x * this.pixelWidth, y * this.pixelHeight, this.pixelWidth, this.pixelHeight);
          }
        }
      }

      updateStats(row) {
        const counts = [0, 0, 0];
        for (const value of row) counts[value] += 1;
        document.getElementById('generation').textContent = this.generation.toString();
        document.getElementById('white-count').textContent = counts[0];
        document.getElementById('gray-count').textContent = counts[1];
        document.getElementById('black-count').textContent = counts[2];
        document.getElementById('rule-label').textContent = this.rule.toString();
        this.renderRuleCards();
      }

      renderRuleCards() {
        const container = document.getElementById('rule-table');
        container.innerHTML = '';
        const averages = ['0', '1/3', '2/3', '1', '4/3', '5/3', '2'];
        for (let sum = 0; sum <= 6; sum++) {
          const div = document.createElement('div');
          div.className = 'rule-card';
          div.style.background = COLOR_SET[this.ruleTable[sum]];
          div.style.color = this.ruleTable[sum] === 0 ? '#000' : '#fff';
          div.innerHTML = `${averages[sum]}<br>→ ${this.ruleTable[sum]}`;
          container.appendChild(div);
        }
      }
    }

    const canvas = document.getElementById('ca-canvas');
    const automaton = new ThreeColorAutomaton(canvas);
    automaton.reset();

    const ruleSelect = document.getElementById('rule-select');
    const customWrapper = document.getElementById('custom-wrapper');
    const customInput = document.getElementById('custom-rule');

    ruleSelect.addEventListener('change', () => {
      if (ruleSelect.value === 'custom') {
        customWrapper.style.display = 'block';
        customInput.focus();
        return;
      }
      customWrapper.style.display = 'none';
      automaton.setRule(parseInt(ruleSelect.value, 10));
    });

    customInput.addEventListener('change', () => {
      const value = Number(customInput.value);
      if (!Number.isNaN(value)) {
        automaton.setRule(value);
      }
    });

    document.getElementById('seed-select').addEventListener('change', (event) => {
      automaton.setSeed(event.target.value);
    });

    document.getElementById('run-btn').addEventListener('click', () => {
      if (automaton.running) {
        automaton.stop();
        document.getElementById('run-btn').textContent = 'Run';
      } else {
        automaton.run();
        document.getElementById('run-btn').textContent = 'Pause';
      }
    });

    document.getElementById('step-btn').addEventListener('click', () => {
      automaton.stop();
      document.getElementById('run-btn').textContent = 'Run';
      automaton.step();
    });

    document.getElementById('reset-btn').addEventListener('click', () => {
      automaton.reset();
      document.getElementById('run-btn').textContent = 'Run';
    });

    automaton.renderRuleCards();
  </script>
</body>
</html>
