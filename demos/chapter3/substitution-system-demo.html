<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Substitution Systems – NKS Chapter 3</title>
  <style>
    :root { color-scheme: light dark; }
    body {
      margin: 0;
      font-family: "Helvetica Neue", Arial, sans-serif;
      background: #f4f4f4;
      color: #1f1f1f;
    }
    main { max-width: 840px; margin: 0 auto; padding: 28px 20px 40px; }
    header { margin-bottom: 22px; }
    h1 { margin: 0 0 0.4rem; font-size: 1.85rem; }
    p { margin: 0; line-height: 1.55; }
    section {
      background: #fff;
      border: 1px solid #d8d8d8;
      border-radius: 10px;
      padding: 18px 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .controls { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    label { display: block; font-weight: 600; margin-bottom: 6px; }
    select, button {
      font: inherit;
      padding: 7px 9px;
      border-radius: 6px;
      border: 1px solid #b6b6b6;
      background: #fff;
      width: 100%;
    }
    button {
      background: #1f63c7;
      border-color: #1f63c7;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    button.secondary {
      background: #f1f1f1;
      border-color: #c2c2c2;
      color: #232323;
    }
    button + button { margin-top: 8px; }
    dl { margin: 0; }
    dt { font-weight: 600; }
    dd { margin: 0 0 8px 0; }
    .output {
      background: #fafafa;
      border: 1px solid #d4d4d4;
      border-radius: 8px;
      padding: 16px;
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 0.92rem;
      max-height: 360px;
      overflow-y: auto;
      line-height: 1.4;
    }
    .row { margin-bottom: 6px; }
    .stats { display: flex; flex-wrap: wrap; gap: 16px; font-size: 0.95rem; margin-top: 12px; }
    .stat { min-width: 110px; }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>Parallel Substitution Systems</h1>
      <p>
        The examples here are exactly those used in chapter 3 to demonstrate neighbour-independent substitution. Every symbol in
        the string is replaced simultaneously according to the listed rules. The growth sequences and alphabet choices match the
        original NKS interactive demo.
      </p>
    </header>

    <section class="controls">
      <div>
        <label for="system-select">Choose system</label>
        <select id="system-select">
          <option value="fibonacci">Fibonacci (A→AB, B→A)</option>
          <option value="period">Period doubling (A→AB, B→AA)</option>
          <option value="thue">Thue–Morse (0→01, 1→10)</option>
          <option value="cantor">Cantor set (A→ABA, B→BBB)</option>
        </select>
      </div>
      <div>
        <label>Simulation control</label>
        <button id="run-btn">Run</button>
        <button id="step-btn" class="secondary">Step once</button>
        <button id="reset-btn" class="secondary">Reset</button>
      </div>
      <div>
        <label>Rules</label>
        <dl id="rule-list"></dl>
      </div>
    </section>

    <section>
      <div class="output" id="output"></div>
      <div class="stats">
        <div class="stat"><strong>Generation:</strong> <span id="generation">0</span></div>
        <div class="stat"><strong>Length:</strong> <span id="length">1</span></div>
        <div class="stat"><strong>Alphabet:</strong> <span id="alphabet">A</span></div>
      </div>
    </section>
  </main>

  <script>
    const SYSTEMS = {
      fibonacci: {
        seed: 'A',
        rules: { A: 'AB', B: 'A' }
      },
      period: {
        seed: 'A',
        rules: { A: 'AB', B: 'AA' }
      },
      thue: {
        seed: '0',
        rules: { '0': '01', '1': '10' }
      },
      cantor: {
        seed: 'A',
        rules: { A: 'ABA', B: 'BBB' }
      }
    };

    class SubstitutionDemo {
      constructor() {
        this.setSystem('fibonacci');
        this.running = false;
        this.timer = null;
      }

      setSystem(name) {
        const preset = SYSTEMS[name];
        this.rules = preset.rules;
        this.seed = preset.seed;
        this.reset();
        this.renderRules();
      }

      reset() {
        this.stop();
        this.generations = [this.seed];
        this.generation = 0;
        this.render();
      }

      step() {
        if (this.generations.length >= 16) return;
        const current = this.generations[this.generations.length - 1];
        let next = '';
        for (const ch of current) {
          next += this.rules[ch] ?? ch;
        }
        this.generations.push(next);
        this.generation = this.generations.length - 1;
        this.render();
      }

      run() {
        if (this.running) return;
        this.running = true;
        const loop = () => {
          if (!this.running) return;
          this.step();
          this.timer = setTimeout(() => requestAnimationFrame(loop), 160);
        };
        loop();
      }

      stop() {
        this.running = false;
        if (this.timer) {
          clearTimeout(this.timer);
          this.timer = null;
        }
      }

      renderRules() {
        const list = document.getElementById('rule-list');
        list.innerHTML = '';
        Object.entries(this.rules).forEach(([lhs, rhs]) => {
          const dt = document.createElement('dt');
          dt.textContent = lhs;
          const dd = document.createElement('dd');
          dd.textContent = `→ ${rhs}`;
          list.appendChild(dt);
          list.appendChild(dd);
        });
      }

      render() {
        const container = document.getElementById('output');
        container.innerHTML = '';
        this.generations.forEach((word, index) => {
          const div = document.createElement('div');
          div.className = 'row';
          div.textContent = `${index.toString().padStart(2, '0')}: ${word}`;
          container.appendChild(div);
        });
        const latest = this.generations[this.generations.length - 1];
        document.getElementById('generation').textContent = (this.generations.length - 1).toString();
        document.getElementById('length').textContent = latest.length.toString();
        const alphabet = new Set(Array.from(latest));
        document.getElementById('alphabet').textContent = Array.from(alphabet).sort().join(', ');
      }
    }

    const demo = new SubstitutionDemo();

    document.getElementById('system-select').addEventListener('change', (event) => {
      demo.setSystem(event.target.value);
      document.getElementById('run-btn').textContent = 'Run';
    });

    document.getElementById('run-btn').addEventListener('click', () => {
      if (demo.running) {
        demo.stop();
        document.getElementById('run-btn').textContent = 'Run';
      } else {
        demo.run();
        document.getElementById('run-btn').textContent = 'Pause';
      }
    });

    document.getElementById('step-btn').addEventListener('click', () => {
      demo.stop();
      document.getElementById('run-btn').textContent = 'Run';
      demo.step();
    });

    document.getElementById('reset-btn').addEventListener('click', () => {
      demo.reset();
      document.getElementById('run-btn').textContent = 'Run';
    });
  </script>
</body>
</html>
